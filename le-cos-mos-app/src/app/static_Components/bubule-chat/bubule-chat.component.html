<div (click)=" this.isWindowOpen = !this.isWindowOpen" [style]="{'width': isWindowOpen ? '100%' : '0%'}" id="blur">
  </div>
<div

  (click)="isWindowOpen = !isWindowOpen"
  class="bubleChatOutline"
  id="wrapper"
>
  <img
    *ngIf="!isWindowOpen"
    id="bubleChat"
    src="../../../assets/images/chat-right-fill.svg"
  />
  <img
    *ngIf="isWindowOpen"
    id="bubleChat"
    src="../../../assets/images/chat-right-fill-dark.svg"
  />
</div>

<div [ngClass]="isWindowOpen ? 'open' : 'close'" id="window">
  <div id="leftWrp">
    <div id="three-buttons" *ngIf="isWindowOpen">
      <a
        (click)="discussionTypeView = 'global';globalIndex = 0"
        [style]="{
          'background-color':
            discussionTypeView == 'global' ? 'var(--dblue-them-color)' : ''
        }"
        title="Discussions générales"
      >
        <svg
          [style]="{
            fill: discussionTypeView == 'global' ? 'var(--white-them-color)' : ''
          }"
          id="img1"
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          fill="currentColor"
          class="bi bi-people-fill"
          viewBox="0 0 16 16"
        >
          <path
            d="M7 14s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1H7Zm4-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6Zm-5.784 6A2.238 2.238 0 0 1 5 13c0-1.355.68-2.75 1.936-3.72A6.325 6.325 0 0 0 5 9c-4 0-5 3-5 4s1 1 1 1h4.216ZM4.5 8a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z"
          />
        </svg>
      </a>
      <a
        (click)="discussionTypeView = 'private';globalIndex = 0"
        [style]="{
          'background-color':
            discussionTypeView == 'private' ? 'var(--dblue-them-color)' : ''
        }"
        title="Discussions privées"
      >
        <svg
          [style]="{
            fill: discussionTypeView == 'private' ? 'var(--white-them-color)' : ''
          }"
          id="img2"
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          fill="currentColor"
          class="bi bi-person-fill"
          viewBox="0 0 16 16"
        >
          <path
            d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3Zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"
          />
        </svg>
      </a>
      <a [matMenuTriggerFor]="menu" title="Créer une discussion">
        <svg
          id="img3"
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          fill="currentColor"
          class="bi bi-person-fill-add"
          viewBox="0 0 16 16"
        >
          <path
            d="M12.5 16a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Zm.5-5v1h1a.5.5 0 0 1 0 1h-1v1a.5.5 0 0 1-1 0v-1h-1a.5.5 0 0 1 0-1h1v-1a.5.5 0 0 1 1 0Zm-2-6a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"
          />
          <path
            d="M2 13c0 1 1 1 1 1h5.256A4.493 4.493 0 0 1 8 12.5a4.49 4.49 0 0 1 1.544-3.393C9.077 9.038 8.564 9 8 9c-5 0-6 3-6 4Z"
          />
        </svg>
        <mat-menu #menu matMenu="menu">
          <mat-form-field
            (click)="$event.stopPropagation()"
            floatLabel="always"
          >
            <mat-label>Nom du group</mat-label>
            <input #groupName matInput />
          </mat-form-field>
          <button (click)="createDiscussionGroup(groupName.value)" style="border: 1px solid var(--dblue-them-color)" mat-button>
            Créer le group {{ groupName.value }}
          </button>
        </mat-menu>
      </a>
      <a (click)="setPagination()" [matMenuTriggerFor]="menu2" title="Rechercher un utilisateur">
        <svg
         id="img4"
        xmlns="http://www.w3.org/2000/svg"
        width="16"
        height="16"
        fill="currentColor"
        class="bi bi-person-fill-add"
        viewBox="0 0 16 16">
          <path d="M6 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm-5 6s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H1zM11 3.5a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1h-4a.5.5 0 0 1-.5-.5zm.5 2.5a.5.5 0 0 0 0 1h4a.5.5 0 0 0 0-1h-4zm2 3a.5.5 0 0 0 0 1h2a.5.5 0 0 0 0-1h-2zm0 3a.5.5 0 0 0 0 1h2a.5.5 0 0 0 0-1h-2z"/>
        </svg>

        <mat-menu  #menu2 matMenu="menu">
<h3 style="text-align: center;">Liste des utilisateurs</h3>
<div style="margin:auto;width:fit-content">
          <mat-form-field style="text-align: center;margin:auto" (click)="$event.stopPropagation()" [floatLabel]="'always'" id="search">
            <input matInput (keyup)="applyFilter($event)" #input>
            <mat-label>Rechercher un utilisateur</mat-label>
          </mat-form-field>
        </div>
          <table (click)="$event.stopPropagation()" style="width:100%"  [ngClass]="'form'" mat-table
          [dataSource]="dataSource!" multiTemplateDataRows
          class="mat-elevation-z8">

     <ng-container matColumnDef="firstname">

       <td fxLayoutAlign="center center" fxFlex="100" style="text-align: center;"   mat-cell *matCellDef="let element">
         {{element.firstname}}
       </td>

     </ng-container>
     <ng-container matColumnDef="lastname">

       <td fxLayoutAlign="center center" fxFlex="100" style="text-align: center;"   mat-cell *matCellDef="let element">
         {{element.lastname}}
       </td>

     </ng-container>
     <ng-container matColumnDef="type">

      <td fxLayoutAlign="center center" fxFlex="100" style="text-align: center;"   mat-cell *matCellDef="let element">
        ({{element.userType}})

      </td>

    </ng-container>

    <ng-container matColumnDef="button">

      <td fxLayoutAlign="center center" fxFlex="100" style="text-align: center;"   mat-cell *matCellDef="let element">
        <button (click)="createSingleDiscussion(element._id)"   mat-button
        ><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chat-fill" viewBox="0 0 16 16">
          <path d="M8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6-.097 1.016-.417 2.13-.771 2.966-.079.186.074.394.273.362 2.256-.37 3.597-.938 4.18-1.234A9.06 9.06 0 0 0 8 15z"/>
        </svg></button>
      </td>

    </ng-container>


     <tr mat-row *matRowDef="let element; columns: columnsToDisplayUser;"
         class="example-element-row"
         [class.example-expanded-row]="expandedElement === element"
         >

     </tr>

   </table>

   <mat-paginator style="min-width:max-content;width:50%" (click)="$event.stopPropagation()"   [pageSizeOptions]="[5, 10]"
showFirstLastButtons
aria-label="Page">
</mat-paginator>
        </mat-menu>
      </a>
    </div>

    <div id="discussion-dg">
      <div
      (click)="getMessageList(discussion._id!,'click');globalIndex = i"
      *ngFor="let discussion of (discussionTypeView == 'global' ? globalDiscussionList : privateDiscussionList);index as i"
        [style]="{
          'background-color':
          discussion._id! == selectedDiscussion ? 'var(--dblue-them-color)' : '',
          color:
          discussion._id! == selectedDiscussion ? 'var(--white-them-color)' : ''
        }"

      >
        {{ discussion ? discussion.name : 'null' }}
        <label style="font-size: 75%; text-align: right; width: 25%"
          >{{ discussion ? discussion.user_list.length : 'null' }} user(s)</label
        >
      </div>
    </div>
  </div>

  <div id="rightWrp">
    <div id="title">
      <label>{{ selectedDiscussionName }} | {{messageList.length}} Messages affichés</label>
    </div>
    <div  id="messageWrapper">
      <img (click)="isScrollLocked = !isScrollLocked" *ngIf="isScrollLocked" id="lock" src="../../../assets/images/lock-fill.svg">
      <img (click)="isScrollLocked = !isScrollLocked" *ngIf="!isScrollLocked" id="unlock" src="../../../assets/images/unlock-fill.svg">
      <div (scroll)="onScrollMessageList()" id="messageList" >

        <div style="margin-top: 3vh;margin-bottom: 3vh;"
          [class]="message.user_id ==  user_id ? 'yours' : 'his'"
          *ngFor="let message of messageList;index as i"
        >

          <div  id="labels-wrapper">
            <svg
            *ngIf="!message.user_id"
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            fill="currentColor"
            class="bi bi-person-fill"
            viewBox="0 0 16 16"
          >
            <path
              d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3Zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"
            />
          </svg>
          <img *ngIf="message.user_id" id="img2" [src]="imgFile[this.profilePictureList.indexOf(message.user_id)]" [class]="message.user_id ==  user_id ? 'yoursImg' : 'hisImg'">
            <label
              >{{  message.emiter
              }}{{ " " + message.date }} :</label
            >

          </div>


          <div style="display:grid">
            <label id="msg" style="height: max-content" >{{ message.message }}</label>
            <span  id="messageFileName" *ngFor="let filename of message.filesName">
             <label  [matMenuTriggerFor]="menu"> {{filename}}

              <mat-menu   #menu="matMenu">

                <button  (click)="downloadFile(filename)" mat-button>Télécharger le fichier</button>

              </mat-menu>
            </label>

            </span>

          </div>





        </div>

      </div>

      <div *ngIf="isWindowOpen" class="messageSubWrp">
        <mat-form-field>
          <textarea
          [value]="textAreaValue"
            #message
            id="messageInput"
            placeholder="Message"
            matInput
          ></textarea>
        </mat-form-field>

        <div id="queueWrapper">

          <span id="fileName" style="font-size:60%;min-width:max-content" *ngFor="let file of uploader.queue;index as i">
            {{file._file.name || "No file uploaded yet."}}
            <img id="trash-file" height="25px" width="15px" (click)="uploader.removeFromQueue(uploader.queue[i])" src="../../../assets/images/trash3-fill.svg">
          </span>

        </div>

        <button style="cursor: pointer;" mat-mini-fab color="primary"

        >   <mat-icon>attach_file</mat-icon>
        <input
        type="file"
        id="fileUpload"
        ng2FileSelect
        accept=".pdf,.jpg,.png,.jpeg,.ppt,.xls,.docx"
        [uploader]="uploader!"
        multiple
        />
        </button>
        <button
        [disabled]="message.value == '' && uploader.queue.length == 0"
        [style]="{'opacity': message.value == '' && (uploader.queue.length == 0) ? '0.4' : '1','background-color':message.value == '' ? 'var(--white-them-color)':'','color':message.value == '' ? 'var(--dblue-them-color)':'' }"
          (click)="sendMessage(message.value); message.value = ''"
          mat-button
        >
          Envoyez
        </button>
      </div>
    </div>
  </div>
</div>
